name: Build and Release

on:
  push:
    branches:
      - '*'
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true
    
    - name: Install libsodium (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: sudo apt-get update && sudo apt-get install -y libsodium-dev
    
    - name: Install libsodium (macOS)
      if: matrix.os == 'macos-latest'
      run: brew install libsodium
    
    - name: Install libsodium (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        $libsodiumVersion = "1.0.20"
        $libsodiumZip = "libsodium-${libsodiumVersion}-msvc.zip"
        $libsodiumUrl = "https://github.com/jedisct1/libsodium/releases/download/${libsodiumVersion}-RELEASE/${libsodiumZip}"
        $libsodiumDest = "C:\libsodium"
        
        Invoke-WebRequest -Uri $libsodiumUrl -OutFile $libsodiumZip
        Expand-Archive -Path $libsodiumZip -DestinationPath $libsodiumDest
        
        $includeDir = "C:\libsodium\libsodium\include"
        $possibleLibDirs = @(
          "C:\libsodium\libsodium\x64\Release\v142\dynamic",
          "C:\libsodium\libsodium\x64\Release\v143\dynamic",
          "C:\libsodium\libsodium\Win32\Release\v142\dynamic",
          "C:\libsodium\libsodium\Win32\Release\v143\dynamic"
        )
        
        $libDir = $possibleLibDirs | Where-Object { Test-Path "$_\libsodium.dll" } | Select-Object -First 1
        
        if (-not $libDir) {
          Write-Error "Could not find libsodium.dll in any of the expected locations"
          exit 1
        }
        
        echo "SODIUM_INCLUDE_DIR=$includeDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "SODIUM_LIB_DIR=$libDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "$libDir" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        
        Copy-Item "$libDir\libsodium.dll" -Destination "C:\Windows\System32\"
      shell: pwsh
    
    - name: Build
      run: |
        go mod tidy
        if [[ "${{ runner.os }}" == "Windows" ]]; then
          export CGO_CFLAGS="-I${{ env.SODIUM_INCLUDE_DIR }}"
          export CGO_LDFLAGS="-L${{ env.SODIUM_LIB_DIR }} -lsodium"
          go build -v -x ./...
        else
          go build -v ./...
        fi
      shell: bash
    
    - name: Test
      run: go test -v ./...

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true
    - name: Install libsodium (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: sudo apt-get update && sudo apt-get install -y libsodium-dev
    - name: Install libsodium (macOS)
      if: matrix.os == 'macos-latest'
      run: brew install libsodium
    - name: Install libsodium (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        $libsodiumVersion = "1.0.20"
        $libsodiumZip = "libsodium-${libsodiumVersion}-msvc.zip"
        $libsodiumUrl = "https://github.com/jedisct1/libsodium/releases/download/${libsodiumVersion}-RELEASE/${libsodiumZip}"
        $libsodiumDest = "C:\libsodium"
        
        Invoke-WebRequest -Uri $libsodiumUrl -OutFile $libsodiumZip
        Expand-Archive -Path $libsodiumZip -DestinationPath $libsodiumDest
        
        $includeDir = "C:\libsodium\libsodium\include"
        $possibleLibDirs = @(
          "C:\libsodium\libsodium\x64\Release\v142\dynamic",
          "C:\libsodium\libsodium\x64\Release\v143\dynamic",
          "C:\libsodium\libsodium\Win32\Release\v142\dynamic",
          "C:\libsodium\libsodium\Win32\Release\v143\dynamic"
        )
        
        $libDir = $possibleLibDirs | Where-Object { Test-Path "$_\libsodium.dll" } | Select-Object -First 1
        
        if (-not $libDir) {
          Write-Error "Could not find libsodium.dll in any of the expected locations"
          exit 1
        }
        
        echo "SODIUM_INCLUDE_DIR=$includeDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "SODIUM_LIB_DIR=$libDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "$libDir" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        
        Copy-Item "$libDir\libsodium.dll" -Destination "C:\Windows\System32\"
      shell: pwsh
    - name: Import GPG key
      uses: crazy-max/ghaction-import-gpg@v6
      id: import_gpg
      with:
        gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
        passphrase: ${{ secrets.PASSPHRASE }}
    - name: Run GoReleaser
      uses: goreleaser/goreleaser-action@v5
      with:
        args: release --clean
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GPG_FINGERPRINT: ${{ steps.import_gpg.outputs.fingerprint }}
        CGO_CFLAGS: -I${{ env.SODIUM_INCLUDE_DIR }}
        CGO_LDFLAGS: -L${{ env.SODIUM_LIB_DIR }} -lsodium